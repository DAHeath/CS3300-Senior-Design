<!--Parses the query string available in the html bar-->
<% query_string = request.query_string
	 unless query_string.nil?
		if query_string.include? "sort-method"
			sort_method = query_string.split("=")[1]
		end
	end
%>

<!--This form effectively "refreshes" the page, populating the query string in the html bar-->
<!--with a sort method corresponding to the user-chosen one, which ruby parses with the method above--> 
<form id="sort-method-form" method="get" action="/teams">
	<input type="hidden" name="sort-method" id="hidden-sort-method" value="team_name" />
</form>

<h1>Listing teams</h1>

<ul class="nav nav-pills">
	<li role="presentation" class="active"><%= link_to 'Home', students_path() + '/' + current_student.id.to_s %></li>
<% if current_student.team_id.nil? %>
	<li role="presentation"><%= link_to 'Create New Team', new_team_path %></li>
<% end %>
</ul><br />

<div class="panel panel-primary">
  <div class="panel-heading">
    <div class="panel-title">
      List of Teams
    </div>
  </div>
  <div class="panel-body">
    <table class="table" style="border: 1px solid rgb(221, 221, 221)">
      <thead>
        <tr>
          <th>Team Name</th>
          <th>Project Name</th>
          <th>Point of Contact</th>
          <th>Number of Members</th>
          <th>Creation Date</th>
					<th>Link</th>
				<% if current_student.team_id.nil? %>
          <th>Join Team</th>
				<% end %>
        </tr>
      </thead>
			
			<div class="row" style="margin-bottom:20px">
				<div class="col col-md-1">
					<div class="btn-group">
						<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
							Sort By <span class="caret"></span>
						</button>
						<ul class="dropdown-menu" role="menu">
							<li><a href="#" id="team-name-header">Team Name</a></li>
							<li><a href="#" id="project-name-header">Project Name</a></li>
							<li><a href="#" id="poc-name-header">Point of Contact</a></li>
							<li><a href="#" id="num-members-header">Number of Members</a></li>
							<li><a href="#" id="creation-date-header">Creation Date</a></li>
						</ul>
					</div>
				</div>
			</div>
      <tbody>
			<% if sort_method.nil? or sort_method == "team_name" %>
				<% @teams.sort! { |a,b| a.name <=> b.name } %>
			<% elsif sort_method == "project_name" %>
				<!--Projects not yet associated with teams-->
			<% elsif sort_method == "poc_name" %>
				<% @teams.sort! { |a,b| [a.point_of_contact.last_name, a.point_of_contact.first_name] <=> [b.point_of_contact.last_name, b.point_of_contact.first_name] } %>
			<% elsif sort_method == "num_members" %>
				<% @teams.sort! { |a,b| a.students.length <=> b.students.length } %>
			<% elsif sort_method == "creation_date" %>
				<% @teams.sort! { |a,b| a.created_at <=> b.created_at } %>
			<% end %>
			<% @teams.each do |team| %>
				<% team_info = ''
					 team.students.each do |student|
						if student == team.point_of_contact
							team_info += student.full_name + ' (PoC) <br />'
						else
							team_info += student.full_name + '<br />'
						end
				   end 
					 team_info += '<br />Contact: ' + '<u>' + team.point_of_contact.email + '</u>'
				%>	
			
				<% if current_student.team_id == team.id %>
				<tr class="alert alert-success table-row" 
						data-toggle="popover" data-placement="right" 
						data-title="<%=team.name%>" 
						data-content="<%=team_info%>">
				<% else %>
				<tr class="table-row" 
						data-toggle="popover" data-placement="right" 
						data-title="<%=team.name%>" 
						data-content="<%=team_info%>">
				<% end %>
					<td><%= team.name %></td>
					<td>Random Project Name</td>
				<% unless team.point_of_contact.nil? %>
					<td><%= team.point_of_contact.last_name + ', ' +
									team.point_of_contact.first_name %></td>
				<% else %>
					<td style="color:red"> Error: no point of contact</td>
				<% end %>
					<td><%= team.students.length %></td>
					<td><%= team.created_at %></td>
				<% if current_student.team_id.nil? %>
					<td><%= link_to 'Click to Join', team_path(id: team.id)%></td>
				<% end %>
					<td><a href="/teams/<%=team.id%>" target="_blank">Link</a></td>
				</tr>
			<% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
	$(document).ready(function() {
		$form = $('#sort-method-form');
		$('#team-name-header').click(function() {
			console.log('Sorting teams by team name.');
			$('#hidden-sort-method').val('team_name');
			$form.submit();
		});
		$('#project-name-header').click(function() {
			console.log('Sorting teams by project name (not yet available).');
			$('#hidden-sort-method').val('project_name');
			$form.submit();
		});
		$('#poc-name-header').click(function() {
			console.log('Sorting teams by point of contact name.');
			$('#hidden-sort-method').val('poc_name');
			$form.submit();
		});
		$('#num-members-header').click(function() {
			console.log('Sorting teams by number of team members.');
			$('#hidden-sort-method').val('num_members');
			$form.submit();
		});
		$('#creation-date-header').click(function() {
			console.log('Sorting teams by team creation date.');
			$('#hidden-sort-method').val('creation_date');
			$form.submit();
		});
	});
	
	$(function () {
		$(".table-row").hover(function () {
			$(this).popover({
				html: true
			}).popover('show');
		}, function () {
			$(this).popover('hide');
		});
	});
</script>
